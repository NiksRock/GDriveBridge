// ============================================================
// GDriveBridge v2 â€” Enterprise Production Schema
// Compliant with DEFT v2.0 Strict Requirements
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// USERS
// DEFT Â§5 â€” Permanent Truth
// ============================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts  GoogleAccount[]
  jobs      TransferJob[]

  @@index([email])
}

// ============================================================
// CONNECTED ACCOUNTS
// DEFT Â§4.1 â€” OAuth + Token Encryption + Isolation
// ============================================================

model GoogleAccount {
  id        String   @id @default(uuid())
  userId    String

  email       String
  avatarUrl   String?
  refreshTokenEncrypted String   // MUST be encrypted at rest

  dailyBytesTransferred BigInt @default(0)
  lastQuotaReset        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  sourceJobs      TransferJob[] @relation("SourceAccount")
  destinationJobs TransferJob[] @relation("DestinationAccount")

  @@unique([userId, email])
  @@index([userId])
}

// ============================================================
// TRANSFER JOB (ROOT SESSION)
// DEFT Â§4.3, Â§6 â€” Orchestration Layer
// ============================================================

model TransferJob {
  id        String @id @default(uuid())
  userId    String

  sourceAccountId      String
  destinationAccountId String

  destinationFolderId String

  mode   TransferMode
  status TransferStatus @default(PENDING)

  totalItems      Int     @default(0)
  completedItems  Int     @default(0)
  failedItems     Int     @default(0)
  skippedItems    Int     @default(0)

  totalBytes      BigInt  @default(0)
  transferredBytes BigInt @default(0)

  riskFlags       Json?
  warnings        Json?

  startedAt  DateTime?
  pausedAt   DateTime?
  finishedAt DateTime?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  sourceAccount      GoogleAccount @relation("SourceAccount", fields: [sourceAccountId], references: [id])
  destinationAccount GoogleAccount @relation("DestinationAccount", fields: [destinationAccountId], references: [id])

  items   TransferItem[]
  events  TransferEvent[]
  logs    TransferLog[]

  @@index([status])
  @@index([userId])
}

// ============================================================
// TRANSFER ITEMS (EVERY FILE + FOLDER)
// DEFT Â§5 â€” All recursion children MUST persist
// DEFT Â§7 â€” Exactly-Once Idempotency
// ============================================================

model TransferItem {
  id          String @id @default(uuid())
  jobId       String

  sourceFileId      String
  sourceParentId    String?
  destinationFileId String?

  fileName     String
  mimeType     String?
  sizeBytes    BigInt?

  checksum     String?
  depth        Int       @default(0)

  status       ItemStatus @default(PENDING)
  retryCount   Int        @default(0)
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job TransferJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([status])
  @@index([sourceFileId])
  @@index([destinationFileId])

  // ðŸ”¥ CRITICAL: Exactly-once expansion protection
  @@unique([jobId, sourceFileId])
}


// ============================================================
// TRANSFER EVENTS (Real-Time + System Events)
// DEFT Â§10 â€” Real-Time Progress
// ============================================================

model TransferEvent {
  id        String @id @default(uuid())
  jobId     String

  type      String
  message   String?
  metadata  Json?

  createdAt DateTime @default(now())

  job TransferJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([type])
}

// ============================================================
// TRANSFER LOGS (Enterprise Audit Trail)
// DEFT Â§4.5, Â§13 â€” Full Audit + Reporting
// ============================================================

model TransferLog {
  id        String @id @default(uuid())
  jobId     String

  level     LogLevel
  action    String
  context   Json?

  createdAt DateTime @default(now())

  job TransferJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([level])
}

// ============================================================
// ENUMS
// ============================================================

enum TransferMode {
  COPY
  MOVE
}

enum TransferStatus {
  PENDING
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
  AUTO_PAUSED_QUOTA
}

enum ItemStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  SKIPPED
  VERIFYING
}

enum LogLevel {
  INFO
  WARNING
  ERROR
}
